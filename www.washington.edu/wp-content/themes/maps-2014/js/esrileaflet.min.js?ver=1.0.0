$(function(){function a(a){var c=L.polygon(a.rawPolygon,{color:"red"});return c._leaflet_id=a.code,c.on("click",b),H.push(c),c}function b(a){var b=a.target._leaflet_id,c=_.findWhere(I,{code:b});x.setView(a.target.getCenter()),e(c),i(c)}function c(a,b){var c=new b([a.lat,a.lng],{title:a.code,id:a.id,stroke:1,weight:0,color:"#f5ff00",fillOpacity:0,opacity:.5,className:"circle-marker "+a.category.join(" "),radius:a.rad}).on("click",k);return c.body=a.body,c.title=a.title,c.image=a.image,c.code=a.code,c}function d(){if(window.location.search.substr(1)){var a=window.location.search.substr(1),b=_.chain(location.search.slice(1).split("&")).map(function(a){return a?a.split("="):void 0}).compact().object().value();b.l&&(a=b.l);var c=window.location.origin+window.location.pathname+"#!/"+a;history.pushState("","",c)}var d=window.location.hash.substr(1),e=d.replace("!/","").split("&")[0];return""!==e?e.toLowerCase():void 0}function e(a){var b=d();b!==a.code&&history.pushState(a.code,a.title,"#!/"+a.code)}function f(a){$("#"+a).prop("checked")?$("path.circle-marker."+a).css({"stroke-width":"12",stroke:S[a]}):$("path.circle-marker."+a).css({stroke:"","stroke-width":""})}function g(){$("#toggle-handle").on("click",function(){q&&l(),j()}),$("#more-resources").on("click",function(){P="show-more-resources",$("#navigator")[0].classList.add(P)}),$(".parking").on("click",h)}function h(){if(x.hasLayer(H[1]))for(var a=0;a<H.length;a++)x.removeLayer(H[a]);else for(var a=0;a<H.length;a++)x.addLayer(H[a])}function i(a){$("#navigator").addClass("show-building-info"),$("#navigator #info-window").html(R(a)),$("#navigator #info-window")[0].classList.remove("show-directions"),$("#navigator #info-window")[0].classList.add("show-building-info"),P="show-building-info"}function j(){""==P?Q=!Q:($("#navigator")[0].classList.remove(P),P="");var a=$("#navigator #info-window")[0].classList;a.contains("photo")&&a.remove("photo"),Q?$("#navigator")[0].classList.add("hide-panel"):$("#navigator")[0].classList.remove("hide-panel")}function k(a){"show-building-info"==P&&l();var b=a.target;o=b;var c={weight:12};buildingLocation=a.target._latlng,$(window).width()<=767?(newPosition=n(buildingLocation),x.panTo(newPosition)):x.panTo(buildingLocation),b.setStyle(c);var d=(D+a.target.options.id,a.target);i(d),e(d),q=!0}function l(){var a={weight:0};o&&o.setStyle(a),q=!1}function m(a){if(void 0!==a&&""!==a){var c=a.toLowerCase(),d=_.findWhere(O.responseJSON.posts,{code:c});if(void 0===d){d=_.findWhere(M.responseJSON.posts,{code:a});var e=L.polygon(d.rawPolygon,{color:"red"}).on("click",b).addTo(G);e._leaflet_id=d.code}else{var e=L.circle([d.lat,d.lng],{title:d.code,stroke:1,weight:12,color:"#f5ff00",fillOpacity:0,opacity:.5,id:d.id,className:"circle-marker "+d.category.join(" "),radius:d.rad}).on("click",k).addTo(G);e.code=d.code,e.title=d.title,e.body=d.body,e.image=d.image}e.fire("click")}}function n(a){var b,c,d,e,f,g,h;return c=108,b=$("#map_canvas").height(),d=b/2-c,e=x.latLngToLayerPoint(a,x.getZoom()),f=L.point(e.x,e.y+d),g=x.layerPointToLatLng(f),h=L.latLng(g.lat,g.lng)}var o,p=!1,q=!1,r=[-122.32296105,47.64674039,-122.28707804,47.66318327],s=10,t=20,u=[47.653851681095,-122.30780562698],v=17,w=new L.LatLngBounds(new L.LatLng(r[1],r[0]),new L.LatLng(r[3],r[2])),x=L.map("map_canvas").fitBounds(w).setView(u,v);L.esri.basemapLayer("Topographic").addTo(x);var y,z,A={minZoom:s,maxZoom:t,bounds:w,opacity:1,attribution:'Rendered with <a href="http://www.maptiler.com/">MapTiler</a>',tms:!1};z="localhost"==window.location.hostname?"http://localhost/cms/maps/wp-content/themes/maps-2014/tiles/retina/{z}/{x}/{y}.png":"/wp-content/themes/maps-2014/tiles/retina/{z}/{x}/{y}.png",y=L.tileLayer(z,A).addTo(x),x.on("movestart",function(){p=!0}),x.on("moveend",function(){p=!1});var B="?json=campusmap.get_parking_lots",C="?json=campusmap.get_locations",D="?json=campusmap.get_infowindow&id=",E=d(),F=Boolean(E),G=L.layerGroup();G.type="circles";var H,I,J,K=L.CircleMarker.extend({options:{body:"Custom data!",image:"More data!",code:"code"}}),M=$.getJSON(B,function(b){I=M.responseJSON.posts,H=[];var d;if(F){var e=_.findWhere(I,{code:E});if(e){d=e;var f=a(e);E==e.code&&(x.addLayer(f),f.fire("click"))}else{$.getJSON(C,function(a){var b=_.findWhere(a.posts,{code:E}),d=c(b,K);d.addTo(x).fire("click")})}}$.each(I,function(b,c){if(c!==d){a(c)}})}),N=$.getJSON(C,function(){}).done(function(){J=N.responseJSON.posts}),O=(d(),$.getJSON(C,function(){}).fail(function(a,b,c){var d=b+", "+c;console.log("Request Failed: "+d)}).done(function(a){$.each(a.posts,function(a,b){var d=c(b,K);d.addTo(G)}),G.addTo(x)}));O.always(function(){var a=_.findWhere(x._targets,{code:d()});a.fire("click")}),g();var P="",Q=!1,R=_.template($("#template-panel").html()),S=(L.icon({iconUrl:"my-icon.png",iconSize:[38,95],iconAnchor:[22,94],popupAnchor:[-3,-76],shadowUrl:"my-icon-shadow.png",shadowSize:[68,95],shadowAnchor:[22,94]}),{computing:"rgba(0, 153, 255)",food:"rgba(255, 173, 0)",gatehouse:"rgba(0, 224, 255)",phones:"rgba(255, 0, 0)",landmarks:"rgba(153, 0, 255)",library:"rgba(255, 133, 0)",visitors:"rgba(48, 230, 23)"}),T=["computing","food","gatehouse","landmarks","library","visitors","phones"];T.forEach(function(a){$("#"+a).on("click",function(){f(a)})}),$("li.search").on("click",function(){$("input.search-bar").toggleClass("open")}),$("#search-wrapper"),window.onpopstate=function(a){var b=d();m(b)}}),window.CampusMap={Models:{},Collections:{},Views:{},Router:{},Overlays:{},settings:{},allowedBounds:{}},CampusMap.initialize=function(){CampusMap.search=new CampusMap.Views.Search({model:new CampusMap.Models.Search})},$(document).ready(CampusMap.initialize),CampusMap.Views.Search=Backbone.View.extend({el:"#search-wrapper",activeClass:"searching",events:{"keydown input":"searchBuildings","click #search-map .search-result":"navigateToBuilding","click .spinner":"reset"},initialize:function(a){_.bindAll(this,"render","empty"),this.template=_.template($("#search-results").html()),this.$results=this.$el.find(".results"),this.model.on("change:results",this.parse,this)},render:function(a){this.$results.append(this.template(a))},empty:function(a){this.$results.html(null),a&&this.deactivate()},reset:function(){this.isActive()&&(this.empty(!0),this.value=null,this.$el.find("input").val(null))},searchBuildings:_.debounce(function(a){return this.value=a.target.value,this.activate(),this.isBlank()?this.empty(!0):void this.model.search(this.value)},200),parse:function(a){this.results=a.attributes.results,this.empty(),_.each(this.results,this.render)},navigateToBuilding:function(a){var b=$(a.target).data().code.toLowerCase();window.location.hash="#!/"+b,this.reset()},isBlank:function(){return/^\s*$/.test(this.value)},isActive:function(){return $("body").hasClass(this.activeClass)},activate:function(){$("body").addClass(this.activeClass),$(window).scrollTop(0)},deactivate:function(){$("body").removeClass(this.activeClass),this.model.set("results",null)}}),CampusMap.Models.Search=Backbone.Model.extend({settings:{json:"campusmap.get_search_results",custom_fields:"code",include:["title","custom_fields"].join(","),search:""},url:Backbone.history.location.pathname,search:function(a){this.settings.search=a,this.fetch({data:this.settings})},parse:function(a){"ok"===a.status&&this.set("results",a.posts)}});